import { useState, useEffect } from 'react';
import axios from 'axios';

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';

export default function App() {
  // State management
  const [mode, setMode] = useState('movies');
  const [movies, setMovies] = useState([]);
  const [books, setBooks] = useState([]);
  const [popularBooks, setPopularBooks] = useState([]);
  const [selectedMovie, setSelectedMovie] = useState('');
  const [selectedBook, setSelectedBook] = useState('');
  const [searchQuery, setSearchQuery] = useState('');
  const [showDropdown, setShowDropdown] = useState(false);
  const [recommendations, setRecommendations] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [count, setCount] = useState(5);
  const [showPopular, setShowPopular] = useState(false);

  // Load data when component mounts or mode changes
  useEffect(() => {
    if (mode === 'movies') {
      fetchMovies();
    } else {
      fetchBooks();
      fetchPopularBooks();
    }
  }, [mode]);

  // Filter items based on search query
  const filteredItems =
    mode === 'movies'
      ? movies.filter((movie) => movie.toLowerCase().includes(searchQuery.toLowerCase()))
      : books.filter((book) => book.toLowerCase().includes(searchQuery.toLowerCase()));

  // Fetch all movies from API
  const fetchMovies = async () => {
    try {
      setLoading(true);
      const response = await axios.get(`${API_URL}/api/movies`);
      setMovies(response.data.movies);
    } catch (err) {
      setError('Failed to load movies. Is the API running?');
    } finally {
      setLoading(false);
    }
  };

  // Fetch all books from API
  const fetchBooks = async () => {
    try {
      setLoading(true);
      const response = await axios.get(`${API_URL}/api/books`);
      setBooks(response.data.books);
    } catch (err) {
      setError('Failed to load books. Is the API running?');
    } finally {
      setLoading(false);
    }
  };

  // Fetch popular books from API
  const fetchPopularBooks = async () => {
    try {
      const response = await axios.get(`${API_URL}/api/books/popular`);
      setPopularBooks(response.data.books);
    } catch (err) {
      console.error('Failed to load popular books:', err);
    }
  };

  // Get recommendations
  const getRecommendations = async () => {
    const selected = mode === 'movies' ? selectedMovie : selectedBook;
    if (!selected) {
      setError(`Please select a ${mode === 'movies' ? 'movie' : 'book'}!`);
      return;
    }

    try {
      setLoading(true);
      setError('');
      setShowPopular(false);

      if (mode === 'movies') {
        const response = await axios.post(`${API_URL}/api/recommend`, {
          movie: selectedMovie,
          count: count,
        });
        setRecommendations(response.data.recommendations);
      } else {
        const response = await axios.post(`${API_URL}/api/books/recommend`, {
          book: selectedBook,
          count: count,
        });
        setRecommendations(response.data.recommendations);
      }
    } catch (err) {
      setError(err.response?.data?.detail || 'Failed to get recommendations');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className='min-h-screen bg-gradient-to-br from-zinc-950 via-black to-zinc-900 py-12 px-4 sm:px-6 lg:px-8'>
      <div className='max-w-5xl mx-auto'>
        <div className='text-center mb-12'>
          <div className='inline-flex items-center gap-3 mb-4'>
            <div className='w-14 h-14 rounded-2xl bg-gradient-to-br from-violet-500 via-purple-500 to-fuchsia-500 flex items-center justify-center text-3xl shadow-xl shadow-purple-500/30'>
              ‚ú®
            </div>
            <h1 className='text-5xl sm:text-6xl font-bold bg-gradient-to-r from-violet-400 via-purple-400 to-fuchsia-400 bg-clip-text text-transparent'>
              RecommendMe
            </h1>
          </div>
          <p className='text-lg text-zinc-400 leading-relaxed max-w-2xl mx-auto mb-8'>
            Discover your next favorite movie or book with AI-powered recommendations
          </p>

          <div className='inline-flex items-center gap-2 p-1.5 bg-zinc-900/80 backdrop-blur-sm border border-zinc-800/50 rounded-full shadow-lg'>
            <button
              onClick={() => {
                setMode('movies');
                setSearchQuery('');
                setSelectedMovie('');
                setSelectedBook('');
                setRecommendations([]);
                setError('');
                setShowPopular(false);
              }}
              className={`px-8 py-3 rounded-full font-semibold transition-all duration-300 flex items-center gap-2 ${
                mode === 'movies'
                  ? 'bg-gradient-to-r from-violet-600 to-purple-600 text-white shadow-lg shadow-purple-900/50 scale-105'
                  : 'text-zinc-400 hover:text-zinc-300'
              }`}
            >
              <span className='text-xl'>üé¨</span>
              <span>Movies</span>
            </button>
            <button
              onClick={() => {
                setMode('books');
                setSearchQuery('');
                setSelectedMovie('');
                setSelectedBook('');
                setRecommendations([]);
                setError('');
                setShowPopular(true);
              }}
              className={`px-8 py-3 rounded-full font-semibold transition-all duration-300 flex items-center gap-2 ${
                mode === 'books'
                  ? 'bg-gradient-to-r from-violet-600 to-purple-600 text-white shadow-lg shadow-purple-900/50 scale-105'
                  : 'text-zinc-400 hover:text-zinc-300'
              }`}
            >
              <span className='text-xl'>üìö</span>
              <span>Books</span>
            </button>
          </div>
        </div>

        {/* Main Card */}
        <div className='bg-zinc-900/50 backdrop-blur-sm border border-zinc-800/50 rounded-3xl shadow-2xl p-8 sm:p-10'>
          {/* Search Input */}
          <div className='mb-8 relative'>
            <label className='block text-sm font-semibold text-zinc-300 mb-3 tracking-wide uppercase'>
              Search for {mode === 'movies' ? 'a Movie' : 'a Book'}
            </label>
            <div className='relative'>
              <div className='absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500'>
                <svg className='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                  <path
                    strokeLinecap='round'
                    strokeLinejoin='round'
                    strokeWidth={2}
                    d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'
                  />
                </svg>
              </div>
              <input
                type='text'
                value={searchQuery}
                onChange={(e) => {
                  setSearchQuery(e.target.value);
                  setShowDropdown(true);
                  setError('');
                  if (mode === 'books') setShowPopular(false);
                }}
                onFocus={() => setShowDropdown(true)}
                placeholder='Start typing to search...'
                className='w-full pl-12 pr-12 py-4 bg-zinc-950/80 border border-zinc-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500/50 text-white placeholder:text-zinc-600 transition-all duration-200'
                disabled={loading || (mode === 'movies' ? movies.length === 0 : books.length === 0)}
              />
              {searchQuery && (
                <button
                  onClick={() => {
                    setSearchQuery('')
                    setSelectedMovie('')
                    setSelectedBook('')
                    setShowDropdown(false)
                    setRecommendations([])
                    if (mode === 'books') setShowPopular(true)
                  }}
                  className='absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 hover:text-zinc-300 transition-colors'
                >
                  <svg className='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                    <path strokeLinecap='round' strokeLinejoin='round' strokeWidth={2} d='M6 18L18 6M6 6l12 12' />
                  </svg>
                </button>
              )}
            </div>

            {/* Searchable Dropdown */}
            {showDropdown && searchQuery && filteredItems.length > 0 && (
              <div className='absolute z-10 w-full mt-2 bg-zinc-950 border border-zinc-800 rounded-xl shadow-2xl max-h-72 overflow-y-auto'>
                {filteredItems.slice(0, 10).map((item, idx) => (
                  <div
                    key={idx}
                    onClick={() => {
                      if (mode === 'movies') {
                        setSelectedMovie(item)
                      } else {
                        setSelectedBook(item)
                      }
                      setSearchQuery(item)
                      setShowDropdown(false)
                      setRecommendations([])
                      if (mode === 'books') setShowPopular(false)
                    }}
                    className='px-5 py-3.5 hover:bg-zinc-900 cursor-pointer border-b border-zinc-800/50 last:border-b-0 transition-all duration-150 text-zinc-300 hover:text-white'
                  >
                    {item}
                  </div>
                ))}
              </div>
            )}

            {searchQuery && filteredItems.length === 0 && (
              <div className='mt-3 text-sm text-zinc-500'>
                No {mode} found matching <span className='text-zinc-400 font-medium'>'{searchQuery}'</span>
              </div>
            )}

            {(selectedMovie || selectedBook) && (
              <div className='mt-4 flex items-center gap-2 text-sm bg-purple-950/30 border border-purple-900/30 px-4 py-2 rounded-lg'>
                <span className='text-zinc-500'>Selected:</span>
                <span className='font-semibold text-purple-400'>
                  {mode === 'movies' ? selectedMovie : selectedBook}
                </span>
              </div>
            )}
          </div>

          {/* Number of Recommendations Input */}
          <div className='mb-8'>
            <label className='block text-sm font-semibold text-zinc-300 mb-3 tracking-wide uppercase'>
              Number of Recommendations
            </label>
            <input
              type='number'
              min='1'
              max='20'
              value={count}
              onChange={(e) => {
                const val = Number.parseInt(e.target.value)
                if (val >= 1 && val <= 20) {
                  setCount(val)
                }
              }}
              className='w-full px-5 py-4 bg-zinc-950/80 border border-zinc-800 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500/50 text-white transition-all duration-200'
            />
            <p className='mt-2 text-xs text-zinc-600'>Choose between 1 and 20 recommendations</p>
          </div>

          {/* Get Recommendations Button */}
          <button
            onClick={getRecommendations}
            disabled={!(selectedMovie || selectedBook) || loading}
            className='w-full bg-gradient-to-r from-violet-600 via-purple-600 to-fuchsia-600 text-white font-semibold py-4 px-6 rounded-xl hover:from-violet-500 hover:via-purple-500 hover:to-fuchsia-500 transform hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 shadow-lg shadow-purple-900/40 disabled:opacity-40 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none'
          >
            {loading ? (
              <span className='flex items-center justify-center gap-3'>
                <svg className='animate-spin h-5 w-5' viewBox='0 0 24 24'>
                  <circle
                    className='opacity-25'
                    cx='12'
                    cy='12'
                    r='10'
                    stroke='currentColor'
                    strokeWidth='4'
                    fill='none'
                  ></circle>
                  <path
                    className='opacity-75'
                    fill='currentColor'
                    d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'
                  ></path>
                </svg>
                <span>Finding matches...</span>
              </span>
            ) : (
              'Get Recommendations'
            )}
          </button>

          {/* Error Message */}
          {error && (
            <div className='mt-6 bg-rose-950/50 border border-rose-900/50 p-4 rounded-xl backdrop-blur-sm'>
              <p className='text-rose-400 text-sm flex items-center gap-2'>
                <svg className='w-5 h-5 flex-shrink-0' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                  <path
                    strokeLinecap='round'
                    strokeLinejoin='round'
                    strokeWidth={2}
                    d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
                  />
                </svg>
                {error}
              </p>
            </div>
          )}

          {/* Popular Books Display */}
          {mode === 'books' && showPopular && popularBooks.length > 0 && (
            <div className='mt-10'>
              <h2 className='text-2xl font-bold text-white mb-6 flex items-center gap-3'>
                <span className='text-3xl'>üî•</span>
                <span>Popular Books</span>
              </h2>
              <div className='grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4'>
                {popularBooks.slice(0, 20).map((book, idx) => (
                  <div
                    key={idx}
                    className='group cursor-pointer'
                    onClick={() => {
                      setSelectedBook(book.title)
                      setSearchQuery(book.title)
                      setShowPopular(false)
                    }}
                  >
                    <div className='relative aspect-[2/3] rounded-lg overflow-hidden shadow-lg hover:shadow-2xl hover:shadow-purple-900/40 transition-all duration-300 transform hover:scale-105 ring-1 ring-zinc-800 hover:ring-purple-500/50'>
                      <img
                        src={book.image_url || '/placeholder.svg?height=300&width=200'}
                        alt={book.title}
                        className='w-full h-full object-cover'
                        onError={(e: any) => {
                          e.target.src =
                            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iIzI3MjcyNyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDgiIGZpbGw9IiM2NjY2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5OaPC90ZXh0Pjwvc3ZnPg=='
                        }}
                      />
                      <div className='absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-3'>
                        <div className='text-xs text-white'>
                          <div className='font-semibold line-clamp-2'>{book.title}</div>
                          <div className='text-zinc-300 text-[10px] mt-1'>{book.author}</div>
                          {book.avg_rating && (
                            <div className='flex items-center gap-1 mt-1'>
                              <span className='text-amber-400'>‚≠ê</span>
                              <span className='text-[10px]'>{book.avg_rating.toFixed(1)}</span>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Recommendations */}
          {recommendations.length > 0 && (
            <div className='mt-10'>
              <h2 className='text-2xl font-bold text-white mb-6'>
                Similar to <span className='text-purple-400'>'{mode === 'movies' ? selectedMovie : selectedBook}'</span>
              </h2>
              {mode === 'movies' ? (
                <div className='space-y-3'>
                  {recommendations.map((rec, idx) => (
                    <div
                      key={idx}
                      className='group flex items-center gap-4 p-4 bg-zinc-950/60 rounded-xl border border-zinc-800/50 hover:border-purple-500/30 hover:bg-zinc-900/60 transition-all duration-300'
                    >
                      <div className='flex-shrink-0 w-10 h-10 bg-gradient-to-br from-violet-500 to-purple-500 text-white rounded-lg flex items-center justify-center font-bold text-base shadow-lg shadow-purple-900/30'>
                        {idx + 1}
                      </div>
                      {rec.poster_url && (
                        <img
                          src={rec.poster_url || '/placeholder.svg?height=120&width=80'}
                          alt={rec.title}
                          className='w-14 h-20 object-cover rounded-lg shadow-md border border-zinc-800'
                          onError={(e: any) => {
                            e.target.style.display = 'none'
                          }}
                        />
                      )}
                      <div className='flex-1 min-w-0'>
                        <p className='text-base font-semibold text-white group-hover:text-purple-400 transition-colors truncate'>
                          {rec.title}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className='grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4'>
                  {recommendations.map((book, idx) => (
                    <div key={idx} className='group'>
                      <div className='relative aspect-[2/3] rounded-lg overflow-hidden shadow-lg hover:shadow-2xl hover:shadow-purple-900/40 transition-all duration-300 transform hover:scale-105 ring-1 ring-zinc-800 hover:ring-purple-500/50'>
                        <img
                          src={book.image_url || '/placeholder.svg?height=300&width=200'}
                          alt={book.title}
                          className='w-full h-full object-cover'
                          onError={(e: any) => {
                            e.target.src =
                              'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iIzI3MjcyNyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDgiIGZpbGw9IiM2NjY2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5OaPC90ZXh0Pjwvc3ZnPg=='
                          }}
                        />
                        <div className='absolute top-2 left-2 w-8 h-8 bg-gradient-to-br from-violet-500 to-purple-500 text-white rounded-lg flex items-center justify-center font-bold text-sm shadow-lg'>
                          {idx + 1}
                        </div>
                        <div className='absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-3'>
                          <div className='text-xs text-white'>
                            <div className='font-semibold line-clamp-2'>{book.title}</div>
                            <div className='text-zinc-300 text-[10px] mt-1'>{book.author}</div>
                            {book.avg_rating && (
                              <div className='flex items-center gap-1 mt-1'>
                                <span className='text-amber-400'>‚≠ê</span>
                                <span className='text-[10px]'>{book.avg_rating.toFixed(1)}</span>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Footer Info */}
          <div className='mt-10 pt-6 border-t border-zinc-800/50 text-center'>
            <p className='text-sm text-zinc-600'>
              {mode === 'movies'
                ? `${movies.length} movies available ‚Ä¢ Content-Based Recommender System`
                : `${books.length} books available ‚Ä¢ Content-Based Recommender System`}
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}
